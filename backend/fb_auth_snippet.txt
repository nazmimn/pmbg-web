from fastapi_sso.sso.facebook import FacebookSSO

# Facebook Configuration
FB_CLIENT_ID = os.environ.get("FACEBOOK_APP_ID", "YOUR_FB_APP_ID_PLACEHOLDER")
FB_CLIENT_SECRET = os.environ.get("FACEBOOK_APP_SECRET", "YOUR_FB_APP_SECRET_PLACEHOLDER")
# Important: This URL must match exactly what you register in Facebook
# In production, this must be HTTPS
FB_REDIRECT_URI = os.environ.get("FACEBOOK_REDIRECT_URI", "http://localhost:8001/api/auth/facebook/callback")

facebook_sso = FacebookSSO(
    client_id=FB_CLIENT_ID,
    client_secret=FB_CLIENT_SECRET,
    redirect_uri=FB_REDIRECT_URI,
    allow_insecure_http=True # Allow localhost
)

@api_router.get("/auth/facebook/login")
async def facebook_login():
    """Redirect user to Facebook Login"""
    return await facebook_sso.get_login_redirect()

@api_router.get("/auth/facebook/callback")
async def facebook_callback(request: Request, response: Response):
    """Handle Facebook Callback"""
    try:
        user_sso = await facebook_sso.verify_and_process(request)
        
        # Check if user exists
        user = await db.users.find_one({"email": user_sso.email})
        if not user:
            # Create user
            user_id = str(uuid.uuid4())
            user_doc = {
                "id": user_id,
                "displayName": user_sso.display_name or "Facebook User",
                "email": user_sso.email,
                "picture": user_sso.picture,
                "auth_provider": "facebook",
                "provider_id": user_sso.id,
                "createdAt": datetime.now(timezone.utc).isoformat()
            }
            await db.users.insert_one(user_doc)
            user = user_doc
        
        # Create Session
        await create_session(user['id'], response)
        
        # Redirect to Frontend
        # Get frontend URL from env or referer, default to localhost:3000
        frontend_url = os.environ.get("FRONTEND_URL", "http://localhost:3000")
        
        # We need to manually construct the redirect response to include the cookie set by create_session
        # create_session sets the cookie on the 'response' object passed to it
        # But 'RedirectResponse' is a new object.
        # We need to make sure the cookie is passed along.
        
        redirect = RedirectResponse(url=f"{frontend_url}/dashboard", status_code=302)
        
        # Copy cookies from the response object we modified in create_session
        # (This is a bit tricky in FastAPI because create_session modifies the response passed in, 
        # but we are returning a NEW RedirectResponse)
        # Refactor: create_session should probably return the cookie value or we handle it here.
        
        # Re-implementing session creation logic here for the redirect response specifically
        session_token = str(uuid.uuid4())
        expires_at = datetime.now(timezone.utc) + timedelta(days=7)
        
        session_doc = {
            "session_token": session_token,
            "user_id": user['id'],
            "expires_at": expires_at,
            "created_at": datetime.now(timezone.utc)
        }
        await db.user_sessions.insert_one(session_doc)
        
        redirect.set_cookie(
            key="session_token",
            value=session_token,
            httponly=True,
            secure=True,
            samesite="none",
            expires=7 * 24 * 60 * 60
        )
        
        return redirect
        
    except Exception as e:
        logger.error(f"Facebook Auth Error: {e}")
        raise HTTPException(status_code=400, detail=str(e))
